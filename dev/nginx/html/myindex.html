<html>
	<head>
		<script>
			var websocket_channel_addr = "ws://192.168.244.130:8080/my_main";
			var websocket_channel = null;
			var text_controls ={
				nationality:"国籍",
				area:"所在地区",
				birthday:"出生日期",
				gender:"性别", 
				entry:"入境时间", 
				company:"就业单位", 
				phone:"联系方式", 
				remark:"备注"};
			var image_controls = {
				photo:"照片",
				fingerprint:"指纹"};
			var structure_num = 1;

			function connect() 
			{
				if (websocket_channel !== null ) 
					return log('already connected');
				websocket_channel = new WebSocket(websocket_channel_addr );
				websocket_channel.onopen = function () 
				{
					log('connected ' + websocket_channel_addr);
				};
				websocket_channel.onerror = function (error) 
				{
					log(error);
				};
				websocket_channel.onmessage = function (e) 
				{
					log('recv: ' + e.data);
					recv(e.data)
				};
				websocket_channel.onclose = function () 
				{
					log('disconnected ' + websocket_channel_addr);
					websocket_channel = null;
				};
				return false;
			}
			function disconnect() 
			{
				if (websocket_channel === null ) 
					return log('already disconnected');
				websocket_channel.close();
				log("request disconnect");
				return false;
			}
			function send()
			{
				if (websocket_channel === null) 
					return log('please connect first');
				var str = '{ "websocket_cmd":"upload", '
				for (var k in text_controls)
				{
					var text = document.getElementById(k)
					str += '"' + k + '":"' + text.value + '",'
				}
				str = str.substring(0, str.length-1)
				for (var k in image_controls)
				{
					var image = document.getElementById(k)
					str += ', "' + k + '":"' + image.src + '"'
				}
				str += "}"

				log('send: ' + websocket_channel_addr + ", str: " + str);
				websocket_channel.send(str);
				return false;
			}
			function recv(str)
			{
				var obj = JSON.parse(str);
				for(var idx in obj.person_info_list)
				{
					var info = obj.person_info_list[idx]
					for(var id in info) 
					{
						var ele = document.getElementById(id)
						if(ele && image_controls[id])
							ele.src = info[id]
						else if(ele)
							ele.value = info[id]
					}
				}
			}
			function query(msg)
			{
				if (websocket_channel === null) 
					return log('please connect first');
				var str = '{ "websocket_cmd":"query", "query_dict":{'
				for (var k in text_controls)
				{
					var text = document.getElementById(k)
					if(text.value != "")
					{
						str += '"' + k + '":"' + text.value + '",'
					}
				}
				str = str.substring(0, str.length-1)
				str += "}}"
				log('query: ' + websocket_channel_addr + ", str: " + str);
				websocket_channel.send(str);
			}
			function empty()
			{
				for (var k in text_controls)
				{
					var text = document.getElementById(k)
					text.value = ""
				}
			}
			function structure()
			{
				document.getElementById("nationality").value = "usa" + structure_num
				document.getElementById("area").value = "tianhe" + structure_num
				document.getElementById("birthday").value = "1990-01-01"
				document.getElementById("gender").value = "female"
				document.getElementById("entry").value = "2000-02-02"
				document.getElementById("company").value = "netease" + structure_num
				document.getElementById("phone").value = "1380000000"
				document.getElementById("remark").value = structure_num

				structure_num += 1
			}
			function test()
			{
				//var text = document.getElementsByName("fname")[0];		//靠, 返回一组数组
    			//console.log('Error: ' + str);
				//alert(text.value)
				//return false;	/*如果没有返回, 会一闪而过*/
			}
			function log(text)
			{
				var li = document.createElement('li')
				li.appendChild(document.createTextNode(text));
				document.getElementById('log').appendChild(li)
				return false;
			}
			function create_text_control()
			{
				var fo = document.getElementById('main_form')
				for (var k in text_controls) 
				{
					var label = document.createElement("label")
					var text = document.createElement("input")
					text.id = k
					text.type = "text"
					//label.for = "label" + text.id
					label.innerHTML = text_controls[k] + ":"
					fo.appendChild(label)
					fo.appendChild(text)
					fo.appendChild(document.createElement("br"))
				}
			}
			function create_image_control()
			{
				var di = document.getElementById('main_form')
				for (var k in image_controls) 
				{
					var img = document.createElement("img")
					var input = document.createElement("input")

					img.alt = image_controls[k]
					img.id = k
					img.width = "100"
					img.height = "100"
					input.type = "file"
					input.id= k + "_file"
					if(k == "photo")
						input.onchange =  function() {read_file("photo_file", "photo")}
					else
						input.onchange =  function() {read_file("fingerprint_file", "fingerprint")}

					di.appendChild(img)
					di.appendChild(input)
					di.appendChild(document.createElement("br"))
				}
			}
			function read_photo_file()
			{
				read_file("photo_file", "photo")
			}
			function read_fingerprint_file()
			{
				read_file("fingerprint_file", "fingerprint")
			}

			function read_file(file_id, img_id)
			{
				var files = document.getElementById(file_id).files
				var file = files[0];
				var maxsize = 64 * 1024;

				// 接受 jpeg, jpg, png 类型的图片
				if (!/\/(?:jpeg|jpg|png)/i.test(file.type)) return;

				var reader = new FileReader();
				reader.onload = function() {
					var result = this.result;
					var img = new Image();

					// 如果图片小于 64kb，不压缩
					if (result.length <= maxsize) {
						to_previewer(file_id, img_id, result)
						return;
					}

					img.onload = function() {
						var compressedDataUrl = compress(img, file.type);
						to_previewer(file_id, img_id, compressedDataUrl)
						img = null;
					};

					img.src = result;
				};

				reader.readAsDataURL(file);
			}

			function to_previewer(file_id, img_id, dataUrl) {
				var file = document.getElementById(file_id);
				var img = document.getElementById(img_id);
				img.src = dataUrl;
				file.value = '';
			}

			function compress(img, fileType) {
				var canvas = document.createElement("canvas");
				var ctx = canvas.getContext('2d');

				var width = img.width;
				var height = img.height;

				canvas.width = width;
				canvas.height = height;

				ctx.fillStyle = "#fff";
				ctx.fillRect(0, 0, canvas.width, canvas.height);
				ctx.drawImage(img, 0, 0, width, height);

				// 压缩
				var base64data = canvas.toDataURL(fileType, 0.1);
				canvas = ctx = null;

				return base64data;
			}
			function create_my_element(str)
			{
				var strs = new Array();
				strs = str.split(",");
				var ele = null
				if(strs[0] == "i")
				{
					ele = document.createElement("input")
					ele.id = strs[1]
					ele.type = "text"
				}
				else if(strs[0] == "t")
				{
					ele = document.createElement("input")
					ele.id = strs[1]
					ele.type = "date"
				}
				else
				{
					ele = document.createElement("label")
					ele.innerHTML = strs[1]
				}
				return ele
			}
			function create_text_control2()
			{
				var tb_ar = [
					[4,    6, 4, 6, 4,       20, 4,    10],
					[4,    6, 4, 6, 4, 10, 4,    10, 4, 6],
					[4, 4, 2, 4, 6, 4, 10, 4, 6, 4,     10],
					]
				var text_ar = [
					["l,中文姓名", "i,chinese_name","l,性别","i,gender","l,就业处所","i,company_address","l,联系方式","i,phone"],
					["l,外文姓名", "i,foreign_name","l,民族","i,nation","l,入境证件","i,enter_certificates","l,号码","i,certificates_id", "l,有效期至", "t,validity_time"],
					["l,身高", "i,height","l,血型","i,blood","l,入境地点","i,enter_place","l,时间","t,enter_date", "l,申请事由", "i,enter_reason"],
					["l,出生日期", "i,birthday","l,文化程度","i,education", "l,居留地点","i,address"],
					["l,出生地", "i,homeplace","l,宗教信仰","i,religion","l,车辆种类","i,car_type","l,车牌号","t,car_number", "l,所属派出所", "i,police"],
					["l,国籍", "i,nationality","l,职业","i,job","l,居留期限自","i,residence_from","l,期限至","t,residence_end", "l,居然证编号", "i,residence_num"],
					["l,国外证件", "i,foreign_certificates","l,号码","i,id","l,处所负责人","i,content_name","l,身份证号码","t,content_id"],
					["l,国外住址", "i,foreign_adress","l,负责人住址","i,content_address","l,联系方式","i,content_phone"],
					["l,备注", "i,remark"],
					]
					var fo = document.getElementById('main_form')
					fo.appendChild(document.createElement("br"))
					for(var i=0; i<text_ar.length; i++)
					{
						for(var j=0; j<text_ar[i].length; j++)
						{
							var ele = create_my_element(text_ar[i][j])
							fo.appendChild(ele)
						}
						fo.appendChild(document.createElement("br"))
					}
			}
			function create_table()
			{
				var title = "同行人员"
				var text_ar = [
					["l,姓名", "l,居留证号码", "l,联系方式", "l,关系"],
					["i,friend_name_1", "i,friend_id_1", "i,friend_phone_1", "i,friend_relation_1"],
					["i,friend_name_2", "i,friend_id_2", "i,friend_phone_2", "i,friend_relation_2"],
					["i,friend_name_3", "i,friend_id_3", "i,friend_phone_3", "i,friend_relation_3"],
				]
				var fo = document.getElementById('main_form')
				var tb = document.createElement("table")
				tb.border = 1
				var la = null
				for(var i=0; i<text_ar.length; i++)
				{
					var tr = document.createElement("tr")
					if(la == null)
					{
						var th = document.createElement("th")
						th.rowSpan = 4		//在javascript中访问属性是大小写区分的。
						la = document.createElement("label")
						la.innerHTML = title
						th.appendChild(la)
						tr.appendChild(th)
					}
					for(var j=0; j<text_ar[i].length; j++)
					{
						var td = document.createElement("td")
						var ele = create_my_element(text_ar[i][j])
						td.appendChild(ele)
						tr.appendChild(td)
					}
					tb.appendChild(tr)
				}
				fo.appendChild(tb)
			}

		</script>
	</head>
<body>
	<form id="main_form">
		<!--<script> create_text_control() </script>-->
		<!--<<script> create_image_control() </script>-->
		<!--<img id="photo" width="100" height="100" />
		<input type="file" id="photo_file" onchange="read_photo_file()"/>-->

		<br>
		<button type="button" onclick="connect()">登录</button>
		<button type="button" onclick="disconnect()">注销</button>
		<button type="button" onclick="send()">上传</button>
		<button type="button" onclick="query()">查询</button>
		<button type="button" onclick="empty()">清空</button>
		<button type="button" onclick="structure()">构造数据</button>
	</form>
		<script> create_table() </script>
		<br/>  
	<ol id="log"></ol>
</body>
</html>

